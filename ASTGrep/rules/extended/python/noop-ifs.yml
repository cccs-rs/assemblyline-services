# yaml-language-server: $schema=https://raw.githubusercontent.com/ast-grep/ast-grep/main/schemas/rule.json

id: python-hyperion-noop-ifs
message: Part of the if statement is a noop to hide the actual code
language: Python
rule:
  kind: if_statement
  pattern: $$$PATTERN
  any:
    - all:
        - matches: elif
        - matches: if
    - matches: if
      not:
        has:
          kind: elif_clause
  has:
    kind: block
    pattern: $$$IF_CODE

utils:
  int_comparation:
    kind: comparison_operator
    not:
      has:
        not:
          any:
            - pattern: "<"
            - pattern: ">"
            - pattern: ">="
            - pattern: "<="
            - pattern: "=="
            - kind: integer
  elif:
    has:
      kind: elif_clause
      all:
        - has:
            kind: comparison_operator
            matches: int_comparation
            pattern: $ELIF_COMP
        - has:
            kind: block
            pattern: $$$ELIF_CODE
  if:
    has:
      field: condition
      matches: int_comparation
      pattern: $IF_COMP

metadata:
  extended-obfuscation: yes
  confirmed-obfuscation: yes
  template_file: python-replace-codepart.yml.j2
  deobfuscate: |
    {
      "type": "template",
      "steps": [
        {"func": "math_eval", "source": "IF_COMP", "output": "IF_RESULT"},
        {"func": "math_eval", "source": "ELIF_COMP", "output": "ELIF_RESULT"},
        {"func": "noop_ifs", "output": "FIX"}
      ]
    }
