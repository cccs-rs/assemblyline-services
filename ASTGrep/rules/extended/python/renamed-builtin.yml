# yaml-language-server: $schema=https://raw.githubusercontent.com/ast-grep/ast-grep/main/schemas/rule.json

id: python-renaming-builtin
message: Renaming builtin is often used as obfuscation method
language: Python
rule:
  any:
    - pattern: $FUNC_NAME = $_
      kind: assignment
      has:
        field: right
        matches: original
    - all:
        - kind: identifier
          pattern: $FUNC_NAME
          inside:
            any:
              - kind: pattern_list
              - kind: tuple_pattern
            all:
              - inside:
                  kind: assignment
                  field: left
              - inside:
                  kind: assignment
                  has:
                    field: right
                    any:
                      - kind: expression_list
                      - kind: tuple
        - any:
            - nthChild: 1
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 1
                      matches: original
            - nthChild: 2
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 2
                      matches: original
            - nthChild: 3
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 3
                      matches: original
            - nthChild: 4
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 4
                      matches: original
            - nthChild: 5
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 5
                      matches: original
            - nthChild: 6
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 6
                      matches: original
            - nthChild: 7
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 7
                      matches: original
            - nthChild: 8
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 8
                      matches: original
            - nthChild: 9
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 9
                      matches: original
            - nthChild: 10
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 10
                      matches: original
            - nthChild: 11
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 11
                      matches: original
            - nthChild: 12
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 12
                      matches: original
            - nthChild: 13
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 13
                      matches: original
            - nthChild: 14
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 14
                      matches: original
            - nthChild: 15
              inside:
                inside:
                  has:
                    field: right
                    has:
                      nthChild: 15
                      matches: original


utils:
  original:
    any:
      - matches: important_builtins
      - kind: parenthesized_expression
        has:
          matches: important_builtins
  important_builtins:
    pattern: $ORIGINAL_NAME
    all:
      - any:
          - kind: identifier
          - kind: attribute
      - any:
          - pattern: eval
          - pattern: exec
          - pattern: str
          - pattern: map
          - pattern: ord
          - pattern: tuple
          - pattern: type
          - pattern: globals
          - pattern: locals
          - pattern: __import__
          - pattern: compile
          - pattern: getattr
          - pattern: dir
          - pattern: vars
          - pattern: bool
          - pattern: float
          - pattern: int
          - pattern: bytes
          - pattern: list
          # TODO: better patterns
          # - pattern: "''.join"
          - pattern: binascii.unhexlify

metadata:
  extended-obfuscation: yes
  confirmed-obfuscation: no
  template_file: python-rename-func.yml.j2
  deobfuscate: |
    {
      "type": "template",
      "steps": []
    }
