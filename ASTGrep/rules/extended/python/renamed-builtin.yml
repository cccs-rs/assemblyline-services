# yaml-language-server: $schema=https://raw.githubusercontent.com/ast-grep/ast-grep/main/schemas/rule.json

id: python-renaming-builtin
message: Renaming builtin is often used as obfuscation method
language: Python
rule:
  any:
    - pattern: $FUNC_NAME = $_
      kind: assignment
      has:
        field: right
        matches: original
    - all:
        - kind: identifier
          inside:
            kind: pattern_list
            inside:
              kind: assignment
        - any:
            - pattern: $FUNC_NAME
              nthChild: 1
              inside:
                kind: pattern_list
                inside:
                  kind: assignment
                  has:
                    kind: expression_list
                    has:
                      nthChild: 1
                      matches: original
            - pattern: $FUNC_NAME
              nthChild: 2
              inside:
                kind: pattern_list
                inside:
                  kind: assignment
                  has:
                    kind: expression_list
                    has:
                      nthChild: 2
                      matches: original
            - pattern: $FUNC_NAME
              nthChild: 3
              inside:
                kind: pattern_list
                inside:
                  kind: assignment
                  has:
                    kind: expression_list
                    has:
                      nthChild: 3
                      matches: original
            - pattern: $FUNC_NAME
              nthChild: 4
              inside:
                kind: pattern_list
                inside:
                  kind: assignment
                  has:
                    kind: expression_list
                    has:
                      nthChild: 4
                      matches: original
            - pattern: $FUNC_NAME
              nthChild: 5
              inside:
                kind: pattern_list
                inside:
                  kind: assignment
                  has:
                    kind: expression_list
                    has:
                      nthChild: 5
                      matches: original
            - pattern: $FUNC_NAME
              nthChild: 6
              inside:
                kind: pattern_list
                inside:
                  kind: assignment
                  has:
                    kind: expression_list
                    has:
                      nthChild: 6
                      matches: original
            - pattern: $FUNC_NAME
              nthChild: 7
              inside:
                kind: pattern_list
                inside:
                  kind: assignment
                  has:
                    kind: expression_list
                    has:
                      nthChild: 7
                      matches: original
            - pattern: $FUNC_NAME
              nthChild: 8
              inside:
                kind: pattern_list
                inside:
                  kind: assignment
                  has:
                    kind: expression_list
                    has:
                      nthChild: 8
                      matches: original
            - pattern: $FUNC_NAME
              nthChild: 9
              inside:
                kind: pattern_list
                inside:
                  kind: assignment
                  has:
                    kind: expression_list
                    has:
                      nthChild: 9
                      matches: original
            - pattern: $FUNC_NAME
              nthChild: 10
              inside:
                kind: pattern_list
                inside:
                  kind: assignment
                  has:
                    kind: expression_list
                    has:
                      nthChild: 10
                      matches: original

utils:
  original:
    any:
      - matches: important_builtins
      - kind: parenthesized_expression
        has:
          matches: important_builtins
  important_builtins:
    pattern: $ORIGINAL_NAME
    all:
      - any:
          - kind: identifier
          - kind: attribute
      - any:
          - pattern: eval
          - pattern: exec
          - pattern: str
          - pattern: map
          - pattern: ord
          - pattern: tuple
          - pattern: type
          - pattern: globals
          - pattern: locals
          - pattern: __import__
          - pattern: compile
          - pattern: getattr
          - pattern: dir
          - pattern: vars
          - pattern: bool
          - pattern: float
          - pattern: int
          - pattern: bytes
          - pattern: list
          # TODO: better patterns
          # - pattern: "''.join"
          - pattern: binascii.unhexlify

metadata:
  extended-obfuscation: yes
  confirmed-obfuscation: no
  template_file: python-rename-func.yml.j2
  deobfuscate: |
    {
      "type": "template",
      "steps": []
    }
