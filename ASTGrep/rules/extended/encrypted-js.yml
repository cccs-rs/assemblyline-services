# yaml-language-server: $schema=https://raw.githubusercontent.com/ast-grep/ast-grep/main/schemas/rule.json
id: obfuscation-encrypted-js
language: JavaScript
message: The code was obfuscated using AES encryption
rule:
  pattern:
    context: const $DECR = $DECRYPT('$DATA', '$AUTH', '$SALT', '$IV', "$MASTER")
    strictness: signature
  # kind: lexical_declaration

  follows:
    stopBy: end
    kind: function_declaration
    pattern:
      context: function $DECRYPT(encdata, $AUTH_TAG_PARAM, $SALT_PARAM, $IV_PARAM, $MASTER_KEY) { $$$ }
      strictness: signature
    has:
      stopBy: end
      all:
        - pattern:
            context: "const $KEY_2 = crypto.scryptSync($MASTER_KEY, Buffer.from($SALT_PARAM, 'hex'), 64, { N: 16384, r: 8, p: 1 }).slice(0, 32)"
            strictness: signature
            # selector: lexical_declaration
            stopBy: end
            preceeds:
              pattern:
                context: const $DECIPHER = crypto.createDecipheriv('aes-256-gcm', $KEY, Buffer.from($IV_PARAM, 'hex'));
                strictness: signature
                stopBy: end
                preceeds:
                  pattern:
                    context: $DECIPHER.setAuthTag(Buffer.from($AUTH_TAG_PARAM, 'hex'));
                    strictness: signature
                    stopBy: end
